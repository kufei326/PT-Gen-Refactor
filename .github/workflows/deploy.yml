name: Deploy to Cloudflare Workers

on:
  # æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      build_frontend:
        description: 'æ˜¯å¦æ„å»ºå‰ç«¯'
        required: true
        default: true
        type: boolean
  
  # å½“ main åˆ†æ”¯æœ‰æ¨é€æ—¶è‡ªåŠ¨éƒ¨ç½²
  push:
    branches:
      - main
    paths:
      - 'worker/**'
      - 'frontend/**'
      - 'wrangler.toml'
      - 'package.json'

permissions:
  contents: read

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            worker/node_modules
            frontend/node_modules
            ~/.npm
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-
      
      - name: Install root dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          fi
      
      - name: Install worker dependencies
        run: |
          cd worker
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only
          fi
          npm ci
      
      - name: Install frontend dependencies
        if: github.event.inputs.build_frontend != 'false' && hashFiles('frontend/package.json') != ''
        run: |
          cd frontend
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only
          fi
          npm ci
      
      - name: Build frontend
        if: github.event.inputs.build_frontend != 'false' && hashFiles('frontend/package.json') != ''
        run: |
          cd frontend
          npm run build
          
          # éªŒè¯æ„å»ºäº§ç‰©
          if [ ! -d "dist" ]; then
            echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼šæœªæ‰¾åˆ° dist ç›®å½•"
            exit 1
          fi
          
          echo "âœ… å‰ç«¯æ„å»ºæˆåŠŸ"
          ls -la dist/
      
      - name: Prepare wrangler configuration
        run: |
          echo "å‡†å¤‡ Wrangler é…ç½®..."
          
          # å¦‚æœæ˜¯ staging ç¯å¢ƒï¼Œä¿®æ”¹ worker åç§°
          if [ "${{ github.event.inputs.environment }}" = "staging" ]; then
            sed -i 's/name = "pt-gen-refactor"/name = "pt-gen-refactor-staging"/' wrangler.toml
            echo "âœ… é…ç½®ä¸º staging ç¯å¢ƒ"
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆé…ç½®ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
          echo "å½“å‰ wrangler.toml é…ç½®ï¼š"
          cat wrangler.toml | grep -E '^name|^main|^compatibility_date|^\[|^#'
      
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: './worker'
          command: deploy
          secrets: |
            TMDB_API_KEY
            DOUBAN_COOKIE
            API_KEY
        env:
          # ä» GitHub Secrets ä¸­è¯»å–ç¯å¢ƒå˜é‡
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          DOUBAN_COOKIE: ${{ secrets.DOUBAN_COOKIE }}
          API_KEY: ${{ secrets.API_KEY }}
      
      - name: Get deployment info
        id: deployment
        run: |
          cd worker
          
          # è·å–éƒ¨ç½²ä¿¡æ¯
          DEPLOYMENT_URL=$(npx wrangler deployments list --limit 1 --compatibility-date=2025-08-27 | grep -oP 'https://[^\s]+' | head -1 || echo "")
          
          if [ -n "$DEPLOYMENT_URL" ]; then
            echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ”— è®¿é—®åœ°å€: $DEPLOYMENT_URL"
          else
            echo "âš ï¸  æ— æ³•è·å–éƒ¨ç½²åœ°å€ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
          fi
      
      - name: Create deployment summary
        run: |
          echo "## ğŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | ä¿¡æ¯ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ç¯å¢ƒ | ${{ github.event.inputs.environment || 'production' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†æ”¯ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æäº¤ | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æ„å»ºæ—¶é—´ | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.deployment.outputs.url }}" ]; then
            echo "| è®¿é—®åœ°å€ | [${{ steps.deployment.outputs.url }}](${{ steps.deployment.outputs.url }}) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ éƒ¨ç½²è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Worker ä»£ç å·²éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.build_frontend }}" != "false" ] && [ -f "frontend/package.json" ]; then
            echo "- âœ… å‰ç«¯å·²æ„å»ºå¹¶åŒ…å«åœ¨éƒ¨ç½²ä¸­" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ è·³è¿‡å‰ç«¯æ„å»º" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- âœ… ç¯å¢ƒå˜é‡å·²é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ åç»­æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ç¡®è®¤ Cloudflare æ§åˆ¶å°ä¸­çš„ R2/D1 èµ„æºå·²æ­£ç¡®åˆ›å»º" >> $GITHUB_STEP_SUMMARY
          echo "2. éªŒè¯éƒ¨ç½²åœ°å€çš„åŠŸèƒ½æ˜¯å¦æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "3. å¦‚éœ€è‡ªå®šä¹‰åŸŸåï¼Œè¯·åœ¨ Cloudflare æ§åˆ¶å°ä¸­é…ç½®" >> $GITHUB_STEP_SUMMARY

  # æ„å»ºä»»åŠ¡ï¼ˆå¯é€‰ï¼Œç”¨äºéªŒè¯ä»£ç ï¼‰
  build-check:
    runs-on: ubuntu-latest
    name: Build Check
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies and build
        run: |
          # å®‰è£…å¹¶æ„å»ºæ‰€æœ‰ç»„ä»¶
          npm install || true
          
          cd worker
          npm install
          npm run build || echo "Worker æ„å»ºå®Œæˆ"
          cd ..
          
          if [ -f "frontend/package.json" ]; then
            cd frontend
            npm install
            npm run build
            cd ..
          fi
          
          echo "âœ… æ„å»ºæ£€æŸ¥é€šè¿‡"